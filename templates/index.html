<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stance Detection</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f7f9;
        }
        h1, h2, h3 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
            white-space: pre-wrap;
            display: none;
        }
        .result-visible {
            display: block !important;
        }
        .example-container {
            margin-top: 30px;
        }
        .examples {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .example {
            background-color: #f1f8ff;
            border: 1px solid #c8e1ff;
            border-radius: 4px;
            padding: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .example:hover {
            background-color: #dbedff;
        }
        .stance {
            font-weight: bold;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-block;
            margin-right: 10px;
        }
        .favor {
            background-color: #d4edda;
            color: #155724;
        }
        .against {
            background-color: #f8d7da;
            color: #721c24;
        }
        .neutral {
            background-color: #e2e3e5;
            color: #383d41;
        }
        .target {
            font-style: italic;
            display: inline-block;
            background-color: #e2e3e5;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            margin: 20px 0;
            display: none;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3498db;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f5f7f9;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-bottom: 1px solid white;
            margin-bottom: -1px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .file-upload {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .file-upload input[type="file"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .file-upload button {
            margin-left: 10px;
        }
        .rows-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 20px;
            padding: 10px;
        }
        .row-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .row-item:hover {
            background-color: #f1f8ff;
        }
        .row-item.selected {
            background-color: #e3f2fd;
        }
        /* Styles for Past Results Tab */
        #past-results-list {
            list-style: none;
            padding: 0;
        }
        #past-results-list li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        #past-results-list li:last-child {
            border-bottom: none;
        }
        .result-actions button {
            margin-left: 5px;
            padding: 5px 10px;
            font-size: 14px;
        }
        .delete-btn {
            background-color: #e74c3c;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }
        #result-table-container {
            margin-top: 20px;
            max-height: 500px;
            overflow: auto;
        }
        #result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        #result-table th, #result-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }
        #result-table th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        #result-table td span.stance {
            font-size: 12px;
            padding: 2px 5px;
        }
        /* Style evaluation percentages */
        #eval-table td.pct-cell {
            text-align: center;
        }
        #eval-table td.pct-cell.low {
             background-color: #f8d7da;
        }
        #eval-table td.pct-cell.medium {
             background-color: #fff3cd;
        }
        #eval-table td.pct-cell.high {
             background-color: #d4edda;
        }
    </style>
</head>
<body>
    <h1>Stance Detection</h1>
    
    <div class="tabs">
        <div class="tab active" data-tab="manual">Manual Input</div>
        <div class="tab" data-tab="csv">Analyze Entire CSV & Download Results</div>
        <div class="tab" data-tab="past-results">Past Analysis</div>
        <div class="tab" data-tab="past-evaluations">Past Evaluations</div>
    </div>
    
    <div id="manual-tab" class="tab-content active">
        <div class="container">
            <textarea id="textInput" placeholder="Enter text to analyze stance..."></textarea>
            <button id="analyzeBtn">Analyze Stance</button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing...</p>
            </div>
            
            <div id="result"></div>
        </div>
        
        <div class="example-container">
            <h3>Examples:</h3>
            <div class="examples">
                <div class="example" data-text="I believe climate change is a serious threat that requires immediate action.">
                    Climate change is a serious threat
                </div>
                <div class="example" data-text="The new tax policy won't help the economy at all and will only benefit the wealthy.">
                    New tax policy criticism
                </div>
                <div class="example" data-text="While artificial intelligence has potential benefits, it also poses significant risks that need to be addressed.">
                    Balanced view on AI
                </div>
                <div class="example" data-text="The latest smartphone release has some interesting features, but I'm not sure if it's worth upgrading.">
                    Opinion on new smartphone
                </div>
            </div>
        </div>
    </div>
    
    <div id="csv-tab" class="tab-content">
        <div class="container">
            <h3>Analyze Entire CSV & Download Results</h3>
            <p>Upload a CSV file. Specify the column containing the text, and optionally, columns containing ground truth target and stance. The results (original text, predicted target/stance, ground truth) will be compiled into an Excel file.</p>

            <div style="margin-bottom: 15px;">
                <label for="columnName">Column with text to analyze:</label>
                <input type="text" id="columnName" value="text" required style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="gtTargetColumn">Column with Ground Truth Target (optional):</label>
                <input type="text" id="gtTargetColumn" value="target" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="gtStanceColumn">Column with Ground Truth Stance (optional):</label>
                <input type="text" id="gtStanceColumn" value="stance" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label for="startRow">Start processing from row number:</label>
                <input type="number" id="startRow" value="1" min="1" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 80px;">
            </div>
            
            <div class="file-upload">
                <input type="file" id="csvFile" accept=".csv" required>
                <button id="analyzeAllBtn">Start Analysis</button>
                <button id="stopAnalysisBtn" style="display: none; background-color: #e74c3c; margin-left: 10px;">Stop Analysis</button>
            </div>
            
            <div class="loading" id="csv-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Processing CSV... This may take a while for large files.</p>
            </div>

            <div id="csv-message" style="margin-top: 20px; padding: 10px; border-radius: 4px; display: none;"></div>
            
            <!-- Progress Display Area -->
            <div id="progress-area" style="margin-top: 20px; display: none;">
                <h4>Live Progress:</h4>
                <pre id="progress-log" style="background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word;"></pre>
                <p id="progress-summary"></p>
            </div>
        </div>
            </div>
            
    <!-- Past Results Tab -->
    <div id="past-results-tab" class="tab-content">
        <div class="container">
            <h3>Past Analysis Results</h3>
            <ul id="past-results-list"></ul>
            <div id="result-view-container" style="margin-top: 20px;">
                 <h4 id="result-view-filename" style="display: none;">Viewing: </h4>
                 <div id="result-table-container"></div>
            </div>
             <div class="loading" id="past-results-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
             <div id="past-results-message" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
        </div>
    </div>

    <!-- Past Evaluations Tab -->
    <div id="past-evaluations-tab" class="tab-content">
        <div class="container">
            <h3>Past Evaluation Results</h3>
             <p>These files contain the original analysis data plus columns for Target/Stance Match Percentage based on LLM evaluation.</p>
            <ul id="past-evaluations-list"></ul>
            <div id="eval-view-container" style="margin-top: 20px;">
                 <h4 id="eval-view-filename" style="display: none;">Viewing: </h4>
                 <div id="eval-table-container"></div>
            </div>
             <div class="loading" id="past-evaluations-loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
             <div id="past-evaluations-message" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Manual input tab functionality
            const analyzeBtn = document.getElementById('analyzeBtn');
            const textInput = document.getElementById('textInput');
            const resultDiv = document.getElementById('result');
            const loadingDiv = document.getElementById('loading');
            const examples = document.querySelectorAll('.example');
            
            analyzeBtn.addEventListener('click', analyzeText);
            
            examples.forEach(example => {
                example.addEventListener('click', function() {
                    textInput.value = this.getAttribute('data-text');
                });
            });
            
            function analyzeText() {
                const text = textInput.value.trim();
                if (!text) {
                    alert('Please enter some text to analyze');
                    return;
                }
                
                // Show loading
                loadingDiv.style.display = 'block';
                resultDiv.style.display = 'none';
                
                fetch('/detect_stance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text }),
                })
                .then(response => response.json())
                .then(data => {
                    loadingDiv.style.display = 'none';
                    
                    if (data.error) {
                        resultDiv.innerHTML = `<strong>Error:</strong> ${data.error}`;
                        if (data.raw_response) {
                            resultDiv.innerHTML += `<br><br><strong>Raw response:</strong><br>${data.raw_response}`;
                        }
                    } else {
                        const stanceClass = data.stance.toLowerCase();
                        resultDiv.innerHTML = `
                            <p><strong>Target:</strong> <span class="target">${data.target}</span></p>
                            <p><strong>Stance:</strong> <span class="stance ${stanceClass}">${data.stance}</span></p>
                        `;
                    }
                    
                    resultDiv.style.display = 'block';
                })
                .catch(error => {
                    loadingDiv.style.display = 'none';
                    resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                    resultDiv.style.display = 'block';
                });
            }
            
            // CSV tab functionality
            const analyzeAllBtn = document.getElementById('analyzeAllBtn');
            const csvFile = document.getElementById('csvFile');
            const columnNameInput = document.getElementById('columnName');
            const gtTargetColumnInput = document.getElementById('gtTargetColumn');
            const gtStanceColumnInput = document.getElementById('gtStanceColumn');
            const startRowInput = document.getElementById('startRow');
            const csvLoading = document.getElementById('csv-loading');
            const csvMessage = document.getElementById('csv-message');
            const stopAnalysisBtn = document.getElementById('stopAnalysisBtn');
            const progressArea = document.getElementById('progress-area');
            const progressLog = document.getElementById('progress-log');
            const progressSummary = document.getElementById('progress-summary');

            let currentTaskID = null;
            let eventSource = null;

            analyzeAllBtn.addEventListener('click', analyzeFullCSV);
            stopAnalysisBtn.addEventListener('click', stopCurrentAnalysis);
            
            function analyzeFullCSV() {
                const file = csvFile.files[0];
                const textColumn = columnNameInput.value.trim();
                const gtTargetColumn = gtTargetColumnInput.value.trim();
                const gtStanceColumn = gtStanceColumnInput.value.trim();
                const startRow = parseInt(startRowInput.value, 10);

                if (!file) {
                    showMessage('Please select a CSV file', 'error');
                    return;
                }
                if (!textColumn) {
                    showMessage('Please enter the column name containing the text', 'error');
                    return;
                }
                if (isNaN(startRow) || startRow < 1) {
                    showMessage('Please enter a valid starting row number (1 or greater)', 'error');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                formData.append('text_column', textColumn);
                formData.append('gt_target_column', gtTargetColumn);
                formData.append('gt_stance_column', gtStanceColumn);
                formData.append('start_row', startRow);

                // Show loading indicator while starting
                // csvLoading.style.display = 'block'; 
                progressArea.style.display = 'none'; // Hide old progress
                progressLog.textContent = ''; // Clear log
                progressSummary.textContent = '';
                csvMessage.style.display = 'none';
                analyzeAllBtn.disabled = true;
                stopAnalysisBtn.style.display = 'none'; // Hide stop initially
                stopAnalysisBtn.disabled = false; // Re-enable stop button

                fetch('/analyze_csv', {
                    method: 'POST',
                    body: formData,
                })
                .then(response => {
                    // csvLoading.style.display = 'none';
                    if (!response.ok) {
                         // Handle HTTP errors (e.g., 400, 500)
                         return response.json().then(data => {
                             throw new Error(data.error || response.statusText);
                         }).catch(() => {
                              throw new Error(`Server error: ${response.status}`);
                         });
                    } 
                    return response.json();
                })
                .then(data => {
                    if (data.task_id) {
                        currentTaskID = data.task_id;
                        showMessage('Analysis started in background. See progress below.', 'info');
                        progressArea.style.display = 'block';
                        progressSummary.textContent = 'Connecting to progress stream...';
                        analyzeAllBtn.style.display = 'none'; // Hide Start button
                        stopAnalysisBtn.style.display = 'inline-block'; // Show Stop button
                        startEventSource(currentTaskID);
                    } else {
                        throw new Error(data.error || "Failed to start analysis task.");
                    }
                })
                .catch(error => {
                    // csvLoading.style.display = 'none';
                    showMessage(`Error starting analysis: ${error.message}`, 'error');
                    analyzeAllBtn.disabled = false; // Re-enable button on error
                });
            }

            function startEventSource(taskID) {
                if (eventSource) {
                    eventSource.close();
                }
                
                eventSource = new EventSource(`/stream_progress/${taskID}`);
                progressLog.textContent = 'Waiting for progress...'; // Initial message

                eventSource.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        updateProgressDisplay(data);
                    } catch (e) {
                        console.error("Failed to parse SSE message data:", event.data, e);
                        progressLog.textContent += `\n[Error parsing message: ${event.data}]`;
                    }
                };

                eventSource.onerror = function(error) {
                    console.error("EventSource failed:", error);
                    showMessage('Connection to progress stream lost or failed.', 'error');
                    progressSummary.textContent = 'Stream connection error.';
                    eventSource.close();
                    resetButtons();
                };
                
                 // Add a specific listener for the close event sent from the backend
                 eventSource.addEventListener('close', function(event) {
                     console.log("SSE stream closed by server.", event.data);
                     eventSource.close();
                     resetButtons();
                     // Final status is usually handled by the last message before close
                     if (!progressSummary.textContent.includes("completed") && !progressSummary.textContent.includes("stopped") && !progressSummary.textContent.includes("Error")) {
                         progressSummary.textContent += " (Stream Closed)";
                     }
                 });
                 eventSource.addEventListener('error', function(event) {
                      // This handles general SSE errors, different from eventSource.onerror
                      console.warn("SSE stream reported an error event:", event);
                      if (eventSource.readyState == EventSource.CLOSED) {
                            showMessage('Connection to progress stream closed unexpectedly.', 'error');
                            resetButtons();
                      }
                 });
            }
            
            function updateProgressDisplay(data) {
                 if (data.type === 'start') {
                     progressSummary.textContent = `Started processing ${data.total_rows} rows...`;
                 } else if (data.type === 'progress') {
                     progressSummary.textContent = `Processing row ${data.row} of ${data.total}. Text: ${data.text}`;
                     // Don't log every single progress update, maybe only results
                 } else if (data.type === 'result') {
                     progressLog.textContent += `\nRow ${data.row}: Target='${data.target}', Stance='${data.stance}'`;
                     // Auto-scroll log
                     progressLog.scrollTop = progressLog.scrollHeight;
                 } else if (data.type === 'status') {
                     progressSummary.textContent = data.message;
                     progressLog.textContent += `\n[Status: ${data.message}]`;
                     progressLog.scrollTop = progressLog.scrollHeight;
                 } else if (data.type === 'saved') {
                      progressSummary.textContent += ` Results saved to ${data.filename}.`;
                      progressLog.textContent += `\n[Saved: ${data.filename}]`;
                      progressLog.scrollTop = progressLog.scrollHeight;
                      // Refresh past results list when done
                      if (document.querySelector('.tab[data-tab="past-results"]').classList.contains('active')){
                        loadPastResults();
                      }
                 } else if (data.type === 'error') {
                     progressSummary.textContent = `Error: ${data.message}`;
                     progressLog.textContent += `\n[ERROR: ${data.message}]`;
                     progressLog.scrollTop = progressLog.scrollHeight;
                     showMessage(`Processing Error: ${data.message}`, 'error'); // Show in main message area too
                     // SSE stream should close automatically after backend sends __ERROR__
                     resetButtons();
                 }
            }
            
            function stopCurrentAnalysis() {
                 if (!currentTaskID) {
                     showMessage("No analysis task is currently running.", 'info');
                     return;
                 }
                 
                 showMessage("Sending stop signal...", 'info');
                 stopAnalysisBtn.disabled = true; // Disable stop button after clicking
                 
                 fetch(`/stop_analysis/${currentTaskID}`, { method: 'POST' })
                     .then(response => response.json())
                     .then(data => {
                         if (data.error) {
                             showMessage(`Failed to send stop signal: ${data.error}`, 'error');
                             stopAnalysisBtn.disabled = false; // Re-enable if failed
                         } else {
                             showMessage(data.message || 'Stop signal sent. Waiting for process to halt.', 'info');
                             // The SSE close event will handle final UI reset
                         }
                     })
                     .catch(error => {
                         showMessage(`Error sending stop signal: ${error.message}`, 'error');
                         stopAnalysisBtn.disabled = false; // Re-enable on network error
                     });
            }

            function resetButtons() {
                analyzeAllBtn.style.display = 'inline-block';
                analyzeAllBtn.disabled = false;
                stopAnalysisBtn.style.display = 'none';
                stopAnalysisBtn.disabled = false; // Ensure it's enabled for next run
                currentTaskID = null;
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
            }

            function showMessage(message, type) {
                 csvMessage.textContent = message;
                 csvMessage.style.backgroundColor = type === 'error' ? '#f8d7da' : '#d4edda';
                 csvMessage.style.color = type === 'error' ? '#721c24' : '#155724';
                 csvMessage.style.border = `1px solid ${type === 'error' ? '#f5c6cb' : '#c3e6cb'}`;
                 csvMessage.style.display = 'block';
            }

            // --- Past Results Tab Functionality --- 
            const pastResultsTab = document.querySelector('.tab[data-tab="past-results"]');
            const pastResultsList = document.getElementById('past-results-list');
            const resultViewContainer = document.getElementById('result-view-container');
            const resultViewFilename = document.getElementById('result-view-filename');
            const resultTableContainer = document.getElementById('result-table-container');
            const pastResultsLoading = document.getElementById('past-results-loading');
            const pastResultsMessage = document.getElementById('past-results-message');
            let currentlyViewing = null; // Track which file is being viewed

            pastResultsTab.addEventListener('click', loadPastResults);

            // Load results when the page initially loads if the tab is active (might not be needed if default is manual)
            // if (pastResultsTab.classList.contains('active')) {
            //     loadPastResults();
            // }

            function loadPastResults() {
                pastResultsLoading.style.display = 'block';
                pastResultsMessage.style.display = 'none';
                resultViewContainer.style.display = 'none'; // Hide table when refreshing list
                resultTableContainer.innerHTML = ''; // Clear old table
                currentlyViewing = null;

                fetch('/list_results')
                    .then(response => response.json())
                    .then(data => {
                        pastResultsLoading.style.display = 'none';
                        pastResultsList.innerHTML = ''; // Clear previous list
                        if (data.error) {
                            showPastResultsMessage(`Error loading results: ${data.error}`, 'error');
                        } else if (data.results && data.results.length > 0) {
                            data.results.forEach(filename => {
                                const li = document.createElement('li');
                                
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = filename;
                                
                                const actionsDiv = document.createElement('div');
                                actionsDiv.className = 'result-actions';
                                
                                const viewButton = document.createElement('button');
                                viewButton.textContent = 'View';
                                viewButton.onclick = () => viewResult(filename);
                                
                                const deleteButton = document.createElement('button');
                                deleteButton.textContent = 'Delete';
                                deleteButton.className = 'delete-btn';
                                deleteButton.onclick = () => deleteResult(filename);

                                const evaluateButton = document.createElement('a'); // Use anchor tag for new tab
                                evaluateButton.textContent = 'Evaluate';
                                evaluateButton.href = `/evaluate/${filename}`; // Link to evaluation page
                                evaluateButton.target = '_blank'; // Open in new tab
                                evaluateButton.className = 'button'; // Style like a button
                                evaluateButton.style.marginLeft = '5px';
                                evaluateButton.style.padding = '5px 10px';
                                evaluateButton.style.fontSize = '14px';
                                evaluateButton.style.textDecoration = 'none';
                                evaluateButton.style.backgroundColor = '#2ecc71'; // Green color

                                actionsDiv.appendChild(viewButton);
                                actionsDiv.appendChild(deleteButton);
                                actionsDiv.appendChild(evaluateButton); // Add evaluate button
                                li.appendChild(nameSpan);
                                li.appendChild(actionsDiv);
                                pastResultsList.appendChild(li);
                            });
                        } else {
                             pastResultsList.innerHTML = '<li>No past results found.</li>';
                        }
                    })
                    .catch(error => {
                        pastResultsLoading.style.display = 'none';
                        showPastResultsMessage(`Network Error: ${error.message}`, 'error');
                    });
            }

            function viewResult(filename) {
                pastResultsLoading.style.display = 'block';
                pastResultsMessage.style.display = 'none';
                resultTableContainer.innerHTML = ''; // Clear previous table

                fetch(`/view_result/${filename}`)
                    .then(response => {
                         if (!response.ok) {
                             throw new Error(`HTTP error! status: ${response.status}`);
                         }
                         return response.json();
                    })
                    .then(data => {
                        pastResultsLoading.style.display = 'none';
                        if (data.error) {
                            showPastResultsMessage(`Error viewing file: ${data.error}`, 'error');
                            resultViewContainer.style.display = 'none';
                        } else if (data.data) {
                            currentlyViewing = filename;
                            displayResultsInTable(data.data, filename);
                        } else {
                            showPastResultsMessage('No data found in file.', 'info');
                            resultViewContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                        pastResultsLoading.style.display = 'none';
                        showPastResultsMessage(`Error fetching result: ${error.message}`, 'error');
                        resultViewContainer.style.display = 'none';
                    });
            }

            function displayResultsInTable(resultsData, filename) {
                resultViewFilename.textContent = `Viewing: ${filename}`;
                resultViewFilename.style.display = 'block';
                resultViewContainer.style.display = 'block';
                resultTableContainer.innerHTML = ''; // Clear previous table

                if (!resultsData || resultsData.length === 0) {
                    resultTableContainer.innerHTML = '<p>No data to display.</p>';
                    return;
                }

                const table = document.createElement('table');
                table.id = 'result-table';
                const thead = table.createTHead();
                const tbody = table.createTBody();
                const headers = Object.keys(resultsData[0]);

                // Create header row
                const headerRow = thead.insertRow();
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });

                // Create data rows
                resultsData.forEach(rowData => {
                    const row = tbody.insertRow();
                    headers.forEach(header => {
                        const cell = row.insertCell();
                        let cellContent = rowData[header] !== null ? rowData[header] : '';
                        
                        // Special formatting for stance
                        if (header === 'Predicted Stance' || header === 'Ground Truth Stance') {
                             if (cellContent && ['FAVOR', 'AGAINST', 'NEUTRAL'].includes(cellContent.toUpperCase())) {
                                const stanceSpan = document.createElement('span');
                                stanceSpan.className = `stance ${cellContent.toLowerCase()}`;
                                stanceSpan.textContent = cellContent;
                                cell.appendChild(stanceSpan);
                             } else {
                                cell.textContent = cellContent; 
                             }
                        } else {
                             cell.textContent = cellContent;
                        }
                    });
                });

                resultTableContainer.appendChild(table);
            }

            function deleteResult(filename) {
                if (!confirm(`Are you sure you want to delete the result file: ${filename}?`)) {
                    return;
                }

                pastResultsLoading.style.display = 'block';
                pastResultsMessage.style.display = 'none';

                fetch(`/delete_result/${filename}`, {
                    method: 'DELETE',
                })
                .then(response => response.json())
                .then(data => {
                    pastResultsLoading.style.display = 'none';
                    if (data.error) {
                        showPastResultsMessage(`Error deleting file: ${data.error}`, 'error');
                    } else {
                        showPastResultsMessage(data.message || 'File deleted.', 'success');
                        // If the deleted file was being viewed, clear the view
                        if (currentlyViewing === filename) {
                             resultViewContainer.style.display = 'none';
                             resultTableContainer.innerHTML = ''; 
                             currentlyViewing = null;
                        }
                        loadPastResults(); // Refresh the list
                    }
                })
                .catch(error => {
                    pastResultsLoading.style.display = 'none';
                    showPastResultsMessage(`Network error: ${error.message}`, 'error');
                });
            }
            
             function showPastResultsMessage(message, type) {
                 pastResultsMessage.textContent = message;
                 pastResultsMessage.style.backgroundColor = type === 'error' ? '#f8d7da' : (type === 'success' ? '#d4edda' : '#e2e3e5');
                 pastResultsMessage.style.color = type === 'error' ? '#721c24' : (type === 'success' ? '#155724' : '#383d41');
                 pastResultsMessage.style.border = `1px solid ${type === 'error' ? '#f5c6cb' : (type === 'success' ? '#c3e6cb' : '#d6d8db')}`;
                 pastResultsMessage.style.display = 'block';
            }

            // --- Past Evaluations Tab Functionality --- 
            const pastEvaluationsTab = document.querySelector('.tab[data-tab="past-evaluations"]');
            const pastEvaluationsList = document.getElementById('past-evaluations-list');
            const evalViewContainer = document.getElementById('eval-view-container');
            const evalViewFilename = document.getElementById('eval-view-filename');
            const evalTableContainer = document.getElementById('eval-table-container');
            const pastEvaluationsLoading = document.getElementById('past-evaluations-loading');
            const pastEvaluationsMessage = document.getElementById('past-evaluations-message');
            let currentlyViewingEvaluation = null; // Track which evaluation file is being viewed

            pastEvaluationsTab.addEventListener('click', loadPastEvaluations);

            function loadPastEvaluations() {
                pastEvaluationsLoading.style.display = 'block';
                pastEvaluationsMessage.style.display = 'none';
                evalViewContainer.style.display = 'none'; 
                evalTableContainer.innerHTML = ''; 
                currentlyViewingEvaluation = null;

                fetch('/list_evaluations') // Use new endpoint
                    .then(response => response.json())
                    .then(data => {
                        pastEvaluationsLoading.style.display = 'none';
                        pastEvaluationsList.innerHTML = ''; 
                        if (data.error) {
                            showPastEvaluationsMessage(`Error loading evaluations: ${data.error}`, 'error');
                        } else if (data.results && data.results.length > 0) {
                            data.results.forEach(filename => {
                                const li = document.createElement('li');
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = filename;
                                const actionsDiv = document.createElement('div');
                                actionsDiv.className = 'result-actions';
                                
                                const viewButton = document.createElement('button');
                                viewButton.textContent = 'View';
                                viewButton.onclick = () => viewEvaluation(filename); // Use new view function
                                
                                const deleteButton = document.createElement('button');
                                deleteButton.textContent = 'Delete';
                                deleteButton.className = 'delete-btn';
                                deleteButton.onclick = () => deleteEvaluation(filename); // Use new delete function
                                
                                // No evaluate button needed here
                                actionsDiv.appendChild(viewButton);
                                actionsDiv.appendChild(deleteButton);
                                li.appendChild(nameSpan);
                                li.appendChild(actionsDiv);
                                pastEvaluationsList.appendChild(li);
                            });
                        } else {
                             pastEvaluationsList.innerHTML = '<li>No past evaluations found.</li>';
                        }
                    })
                    .catch(error => {
                        pastEvaluationsLoading.style.display = 'none';
                        showPastEvaluationsMessage(`Network Error: ${error.message}`, 'error');
                    });
            }

            function viewEvaluation(filename) {
                pastEvaluationsLoading.style.display = 'block';
                pastEvaluationsMessage.style.display = 'none';
                evalTableContainer.innerHTML = '';

                fetch(`/view_evaluation/${filename}`) // Use new endpoint
                    .then(response => {
                         if (!response.ok) {
                             throw new Error(`HTTP error! status: ${response.status}`);
                         }
                         return response.json();
                    })
                    .then(data => {
                        pastEvaluationsLoading.style.display = 'none';
                        if (data.error) {
                            showPastEvaluationsMessage(`Error viewing file: ${data.error}`, 'error');
                            evalViewContainer.style.display = 'none';
                        } else if (data.data) {
                            currentlyViewingEvaluation = filename;
                            displayEvaluationInTable(data.data, filename);
                        } else {
                            showPastEvaluationsMessage('No data found in file.', 'info');
                            evalViewContainer.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        pastEvaluationsLoading.style.display = 'none';
                        showPastEvaluationsMessage(`Error fetching evaluation: ${error.message}`, 'error');
                        evalViewContainer.style.display = 'none';
                    });
            }

            function displayEvaluationInTable(resultsData, filename) {
                evalViewFilename.textContent = `Viewing: ${filename}`;
                evalViewFilename.style.display = 'block';
                evalViewContainer.style.display = 'block';
                evalTableContainer.innerHTML = '';

                if (!resultsData || resultsData.length === 0) {
                    evalTableContainer.innerHTML = '<p>No data to display.</p>';
                    return;
                }

                const table = document.createElement('table');
                table.id = 'eval-table'; // Different ID for potentially different styling
                const thead = table.createTHead();
                const tbody = table.createTBody();
                const headers = Object.keys(resultsData[0]);

                const headerRow = thead.insertRow();
                headers.forEach(headerText => {
                    const th = document.createElement('th');
                    th.textContent = headerText;
                    headerRow.appendChild(th);
                });

                resultsData.forEach(rowData => {
                    const row = tbody.insertRow();
                    headers.forEach(header => {
                        const cell = row.insertCell();
                        let cellContent = rowData[header] !== null ? String(rowData[header]) : ''; // Ensure string conversion
                        
                        if (header === 'Predicted Stance' || header === 'Ground Truth Stance') {
                             if (cellContent && ['FAVOR', 'AGAINST', 'NEUTRAL'].includes(cellContent.toUpperCase())) {
                                const stanceSpan = document.createElement('span');
                                stanceSpan.className = `stance ${cellContent.toLowerCase()}`;
                                stanceSpan.textContent = cellContent;
                                cell.appendChild(stanceSpan);
                             } else {
                                cell.textContent = cellContent; 
                             }
                        } else if (header === 'Target Match Pct' || header === 'Stance Match Pct') {
                             cell.textContent = cellContent;
                             cell.classList.add('pct-cell');
                             // Add conditional background based on percentage
                             const pct = parseInt(cellContent, 10);
                             if (!isNaN(pct)) {
                                if (pct < 50) cell.classList.add('low');
                                else if (pct < 80) cell.classList.add('medium');
                                else cell.classList.add('high');
                             }
                        } else {
                             cell.textContent = cellContent;
                        }
                    });
                });

                evalTableContainer.appendChild(table);
            }

            function deleteEvaluation(filename) {
                if (!confirm(`Are you sure you want to delete the evaluation file: ${filename}?`)) {
                    return;
                }

                pastEvaluationsLoading.style.display = 'block';
                pastEvaluationsMessage.style.display = 'none';

                fetch(`/delete_evaluation/${filename}`, { method: 'DELETE' }) // Use new endpoint
                .then(response => response.json())
                .then(data => {
                    pastEvaluationsLoading.style.display = 'none';
                    if (data.error) {
                        showPastEvaluationsMessage(`Error deleting file: ${data.error}`, 'error');
                    } else {
                        showPastEvaluationsMessage(data.message || 'File deleted.', 'success');
                        if (currentlyViewingEvaluation === filename) {
                             evalViewContainer.style.display = 'none';
                             evalTableContainer.innerHTML = ''; 
                             currentlyViewingEvaluation = null;
                        }
                        loadPastEvaluations(); // Refresh the list
                    }
                })
                .catch(error => {
                    pastEvaluationsLoading.style.display = 'none';
                    showPastEvaluationsMessage(`Network error: ${error.message}`, 'error');
                });
            }
            
             function showPastEvaluationsMessage(message, type) {
                 pastEvaluationsMessage.textContent = message;
                 pastEvaluationsMessage.style.backgroundColor = type === 'error' ? '#f8d7da' : (type === 'success' ? '#d4edda' : '#e2e3e5');
                 pastEvaluationsMessage.style.color = type === 'error' ? '#721c24' : (type === 'success' ? '#155724' : '#383d41');
                 pastEvaluationsMessage.style.border = `1px solid ${type === 'error' ? '#f5c6cb' : (type === 'success' ? '#c3e6cb' : '#d6d8db')}`;
                 pastEvaluationsMessage.style.display = 'block';
            }

        });
    </script>
</body>
</html> 